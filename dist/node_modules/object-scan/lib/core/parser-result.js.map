{"version":3,"file":"parser-result.js","sources":["../../../../../node_modules/object-scan/lib/core/parser-result.js"],"sourcesContent":["\"use strict\";\n\nconst assert = require('assert');\n\nconst {\n  defineProperty\n} = require('../generic/helper');\n\nconst {\n  Wildcard\n} = require('./wildcard');\n\nconst IS_EXCLUDED = Symbol('is-excluded');\n\nconst markExcluded = input => defineProperty(input, IS_EXCLUDED, true);\n\nconst isExcluded = input => input[IS_EXCLUDED] === true;\n\nconst throwError = (msg, input, context = {}) => {\n  throw new Error(Object.entries(context).reduce((p, [k, v]) => `${p}, ${k} ${v}`, `${msg}: ${input}`));\n};\n\nconst getSimple = arrOrSet => {\n  if (Array.isArray(arrOrSet)) {\n    return arrOrSet.length === 1 ? arrOrSet[0] : arrOrSet;\n  }\n\n  return arrOrSet.size === 1 ? arrOrSet.values().next().value : arrOrSet;\n};\n\nmodule.exports = input => {\n  let cResult = new Set();\n  let inArray = false;\n  let excludeNext = false;\n  let cursor = 0; // group related\n\n  const parentStack = [];\n\n  const newChild = asOr => {\n    if (isExcluded(cResult)) {\n      assert(excludeNext === false);\n      excludeNext = true;\n    }\n\n    parentStack.push(cResult);\n    cResult = asOr ? new Set() : [];\n  };\n\n  const finishChild = () => {\n    const parent = parentStack.pop();\n    const parentIsArray = Array.isArray(parent);\n    const child = getSimple(cResult);\n\n    if (!parentIsArray && child instanceof Set) {\n      child.forEach(e => parent.add(e));\n    } else {\n      parent[parentIsArray ? 'push' : 'add'](child);\n    }\n\n    cResult = parent;\n  };\n\n  newChild(false);\n  return {\n    setInArray: (flag, idx) => {\n      if (inArray === flag) {\n        throwError(inArray ? 'Bad Array Start' : 'Bad Array Terminator', input, {\n          char: idx\n        });\n      }\n\n      inArray = flag;\n    },\n    finishElement: (idx, {\n      err,\n      fins,\n      finReq = false\n    }) => {\n      const isFinished = cursor === idx;\n\n      if (isFinished && !fins.includes(input[idx - 1] || null)) {\n        throwError(err, input, {\n          char: idx\n        });\n      }\n\n      if (!isFinished) {\n        if (finReq) {\n          throwError(err, input, {\n            char: idx\n          });\n        }\n\n        const ele = input.slice(cursor, idx);\n\n        if (inArray && !(/^[?*+\\d]+$/.test(ele) || ele.startsWith('(') && ele.endsWith(')'))) {\n          throwError('Bad Array Selector', input, {\n            selector: ele\n          });\n        }\n\n        cResult.push(new Wildcard(inArray ? `[${ele}]` : ele, excludeNext));\n        excludeNext = false;\n      }\n\n      cursor = idx + 1;\n    },\n    startExclusion: idx => {\n      if (excludeNext !== false) {\n        throwError('Redundant Exclusion', input, {\n          char: idx\n        });\n      }\n\n      excludeNext = true;\n    },\n    startGroup: () => {\n      newChild(true);\n\n      if (excludeNext) {\n        markExcluded(cResult);\n        excludeNext = false;\n      }\n\n      newChild(false);\n    },\n    newGroupElement: () => {\n      finishChild();\n      newChild(false);\n    },\n    finishGroup: idx => {\n      if (parentStack.length < 2) {\n        throwError('Unexpected Group Terminator', input, {\n          char: idx\n        });\n      }\n\n      finishChild();\n      finishChild();\n    },\n    finalizeResult: () => {\n      finishChild();\n      assert(excludeNext === false);\n\n      if (parentStack.length !== 0) {\n        throwError('Non Terminated Group', input);\n      }\n\n      if (inArray) {\n        throwError('Non Terminated Array', input);\n      }\n\n      return getSimple(cResult);\n    }\n  };\n};"],"names":["require$$1","require$$2"],"mappings":"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"}